<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <base target="_top">
    <title>å®¶äº‹ãƒ­ã‚° Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .date-wrapper { position: relative; }
        .date-icon { pointer-events: none; }
        body.modal-open { overflow: hidden; }
        .home-date-trigger::-webkit-calendar-picker-indicator {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;
        }
        /* ãƒ­ãƒ¼ãƒ‰ä¸­ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 50; display: flex; justify-content: center; align-items: center; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen pb-20">

    <div id="loading-overlay">
        <div class="text-blue-600 font-bold text-xl animate-pulse">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <header class="bg-white shadow p-4 flex justify-between items-center sticky top-0 z-10">
        <h1 class="text-lg font-bold text-gray-700">å®¶äº‹ãƒ­ã‚° Cloud</h1>
        <button onclick="toggleScreen('settings')" class="text-sm bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">âš™ è¨­å®š</button>
    </header>

    <div id="home-screen" class="p-4 max-w-md mx-auto">
        <div class="mb-6">
            <h2 class="text-sm font-bold text-gray-500 mb-2 uppercase tracking-wide">æ¨å¥¨ã‚¿ã‚¹ã‚¯</h2>
            <div id="reminder-list" class="space-y-2"></div>
        </div>
        <hr class="border-gray-300 my-6">
        <div class="bg-white p-4 rounded-lg shadow">
            <h2 class="text-sm font-bold text-gray-500 mb-3 uppercase tracking-wide">å®Ÿæ–½ãƒ­ã‚°ç™»éŒ²</h2>
            <div class="mb-3">
                <div class="flex gap-2 mb-2">
                    <button type="button" onclick="setFormDate(0)" class="flex-1 bg-blue-100 text-blue-700 text-xs py-2 rounded hover:bg-blue-200">ä»Šæ—¥</button>
                    <button type="button" onclick="setFormDate(-1)" class="flex-1 bg-gray-100 text-gray-700 text-xs py-2 rounded hover:bg-gray-200">æ˜¨æ—¥</button>
                </div>
                <div class="flex items-center gap-2">
                    <input type="text" id="log-date-text" placeholder="YYYYMMDD" class="flex-1 border p-2 rounded text-lg font-mono" onblur="normalizeDateInput(this)">
                    <div class="date-wrapper relative w-10 h-10 bg-gray-100 rounded flex items-center justify-center cursor-pointer hover:bg-gray-200 overflow-hidden">
                        <span class="date-icon text-xl">ğŸ“…</span>
                        <input type="date" id="log-date-picker" class="home-date-trigger opacity-0 absolute inset-0 w-full h-full cursor-pointer" onchange="syncTextFromPicker(this)">
                    </div>
                </div>
            </div>
            <div class="mb-4">
                <input list="task-options" id="log-task-name" autocomplete="off" placeholder="é …ç›®ã‚’é¸æŠã¾ãŸã¯å…¥åŠ›" class="w-full border p-2 rounded text-base">
                <datalist id="task-options"></datalist>
            </div>
            <button onclick="registerLog()" class="w-full bg-blue-600 text-white py-3 rounded font-bold shadow hover:bg-blue-700 active:transform active:scale-95 transition">è¨˜éŒ²ã™ã‚‹</button>
        </div>
    </div>

    <div id="settings-screen" class="hidden p-4 max-w-md mx-auto bg-gray-50 h-screen fixed top-0 left-0 w-full z-20 overflow-y-auto overscroll-none">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold">è¨­å®š</h2>
            <button onclick="toggleScreen('home')" class="text-blue-600 font-bold">å®Œäº†</button>
        </div>

        <div class="bg-white p-4 rounded shadow mb-6">
            <h3 class="font-bold text-gray-700 mb-2" id="edit-title">æ–°è¦é …ç›®ç™»éŒ²</h3>
            <input type="hidden" id="edit-id">
            <div class="grid grid-cols-1 gap-3">
                <input type="text" id="edit-name" placeholder="é …ç›®å (ä¾‹: æ›æ°—æ‰‡æƒé™¤)" class="border p-2 rounded w-full">
                <div class="flex gap-2">
                    <div class="flex-1">
                        <label class="text-xs text-gray-500 block">æœŸé–“(æ—¥)</label>
                        <input type="number" id="edit-period" placeholder="90" class="border p-2 rounded w-full">
                    </div>
                    <div class="w-16">
                        <label class="text-xs text-gray-500 block">è‰²</label>
                        <input type="color" id="edit-color" value="#3B82F6" class="h-10 w-full border rounded cursor-pointer">
                    </div>
                </div>
                <div>
                    <label class="text-xs text-gray-500 block">æœ€çµ‚å®Ÿè¡Œæ—¥</label>
                    <input type="date" id="edit-last-date" class="border p-2 rounded w-full">
                </div>
                <div class="flex gap-2 mt-2">
                    <button onclick="saveItem()" class="flex-1 bg-green-600 text-white py-2 rounded font-bold">ä¿å­˜</button>
                    <button onclick="clearEditForm()" class="px-4 py-2 bg-gray-200 rounded text-gray-600">ã‚¯ãƒªã‚¢</button>
                </div>
            </div>
        </div>

        <h3 class="font-bold text-gray-600 mb-2">ç™»éŒ²æ¸ˆã¿é …ç›®</h3>
        <div id="settings-list" class="space-y-3 pb-10"></div>
    </div>

<script>
    // --- æ—¥ä»˜ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
    function getTodayYMD() { return toYMD(new Date()); }
    function toYMD(d) {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${day}`;
    }
    function getDiffDays(ymd1, ymd2) {
        if (!ymd1 || !ymd2) return 0;
        const d1 = new Date(ymd1);
        const d2 = new Date(ymd2);
        return Math.floor((d1 - d2) / (1000 * 60 * 60 * 24));
    }

    // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
    let items = [];
    let isLoading = false;

    // èµ·å‹•æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    window.onload = () => {
        setFormDate(0);
        fetchDataFromServer();
    };

    function setLoading(bool) {
        isLoading = bool;
        const overlay = document.getElementById('loading-overlay');
        bool ? overlay.classList.remove('hidden') : overlay.classList.add('hidden');
    }

    // GASã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—
    function fetchDataFromServer() {
        setLoading(true);
        google.script.run
            .withSuccessHandler((serverData) => {
                items = serverData;
                renderAll();
                setLoading(false);
            })
            .withFailureHandler((err) => {
                alert("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + err);
                setLoading(false);
            })
            .getAllData();
    }

    function renderAll() {
        renderReminders();
        renderDatalist();
        renderSettingsList();
    }

    // --- UIæ“ä½œç³» (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨ã»ã¼åŒã˜) ---
    function setFormDate(offset) {
        const d = new Date();
        d.setDate(d.getDate() + offset);
        const ymd = toYMD(d);
        document.getElementById('log-date-text').value = ymd;
        document.getElementById('log-date-picker').value = ymd;
    }
    function syncTextFromPicker(picker) { document.getElementById('log-date-text').value = picker.value; }
    function normalizeDateInput(input) {
        let val = input.value.trim();
        if (/^\d{8}$/.test(val)) val = `${val.slice(0,4)}-${val.slice(4,6)}-${val.slice(6,8)}`;
        else if (val.includes('/')) val = val.replace(/\//g, '-');
        const d = new Date(val);
        if (!isNaN(d.getTime())) {
            if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(val)) {
                const parts = val.split('-');
                val = `${parts[0]}-${parts[1].padStart(2,'0')}-${parts[2].padStart(2,'0')}`;
            }
            input.value = val;
            document.getElementById('log-date-picker').value = val;
        }
    }

    // --- ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ç³» (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜) ---
    function renderReminders() {
        const list = document.getElementById('reminder-list');
        list.innerHTML = '';
        const todayYMD = getTodayYMD();
        let hasReminder = false;

        const sorted = [...items].sort((a, b) => {
            if (!a.lastDate) return -1;
            if (!b.lastDate) return 1;
            const overA = getDiffDays(todayYMD, a.lastDate) - a.period;
            const overB = getDiffDays(todayYMD, b.lastDate) - b.period;
            return overB - overA;
        });

        sorted.forEach(item => {
            let isDue = false;
            let msg = "";
            if (!item.lastDate) {
                isDue = true;
                msg = `<span class="text-green-600 font-bold">æœªè¨­å®š</span>`;
            } else {
                const passedDays = getDiffDays(todayYMD, item.lastDate);
                if (passedDays >= item.period) {
                    isDue = true;
                    msg = `å‰å›: ${item.lastDate} (${passedDays}æ—¥å‰), è¨­å®šå‘¨æœŸ: ${item.period}æ—¥`;
                }
            }
            if (isDue) {
                hasReminder = true;
                const div = document.createElement('div');
                div.className = "bg-white p-3 rounded shadow-sm border-l-4 flex justify-between items-center cursor-pointer hover:bg-gray-50 transition";
                div.style.borderLeftColor = item.color;
                div.innerHTML = `<div><div class="font-bold text-gray-800">${item.name}</div><div class="text-xs text-gray-500">${msg}</div></div>`;
                div.onclick = () => {
                    document.getElementById('log-task-name').value = item.name;
                    toggleScreen('home');
                    document.querySelector('.bg-white.p-4.rounded-lg.shadow').scrollIntoView({behavior: "smooth", block: "center"});
                };
                list.appendChild(div);
            }
        });
        if (!hasReminder) list.innerHTML = '<div class="text-center py-4 text-gray-400 text-sm">æ¨å¥¨ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ ğŸ‰</div>';
    }

    function renderDatalist() {
        const dl = document.getElementById('task-options');
        dl.innerHTML = '';
        items.forEach(i => {
            const op = document.createElement('option');
            op.value = i.name;
            dl.appendChild(op);
        });
    }

    function renderSettingsList() {
        const list = document.getElementById('settings-list');
        list.innerHTML = '';
        items.forEach(item => {
            const div = document.createElement('div');
            div.className = "bg-white p-3 rounded border flex justify-between items-center";
            div.innerHTML = `
                <div class="flex items-center gap-2 overflow-hidden">
                    <div class="w-4 h-4 rounded-full flex-shrink-0" style="background:${item.color}"></div>
                    <div class="min-w-0">
                        <div class="font-bold truncate">${item.name}</div>
                        <div class="text-xs text-gray-500">å‘¨æœŸ: ${item.period}æ—¥ / æœ€çµ‚: ${item.lastDate || '-'}</div>
                    </div>
                </div>
                <div class="flex gap-2 flex-shrink-0">
                    <button onclick="editItem('${item.id}')" class="text-blue-600 text-xs border border-blue-200 px-2 py-1 rounded">ç·¨é›†</button>
                    <button onclick="deleteItem('${item.id}')" class="text-red-600 text-xs border border-red-200 px-2 py-1 rounded">å‰Šé™¤</button>
                </div>
            `;
            list.appendChild(div);
        });
    }

    // --- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (ã‚µãƒ¼ãƒãƒ¼é€šä¿¡ã‚ã‚Š) ---
    function registerLog() {
        if (isLoading) return;
        const name = document.getElementById('log-task-name').value.trim();
        const dateStr = document.getElementById('log-date-text').value;

        if (!name || !dateStr) { alert("é …ç›®åã¨æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
        
        // æ—¢å­˜é …ç›®ã«ãªã„å ´åˆã¯ç¢ºèª
        const exists = items.some(i => i.name === name);
        if (!exists && !confirm(`ã€Œ${name}ã€ã¯ãƒªã‚¹ãƒˆã«ã‚ã‚Šã¾ã›ã‚“ã€‚\næ–°è¦é …ç›®ã¨ã—ã¦è¿½åŠ ã—ã¦è¨˜éŒ²ã—ã¾ã™ã‹ï¼Ÿ`)) return;

        setLoading(true);
        google.script.run
            .withSuccessHandler((serverData) => {
                items = serverData;
                document.getElementById('log-task-name').value = '';
                alert(`ã€Œ${name}ã€ã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼`);
                renderAll();
                setLoading(false);
            })
            .registerLogServer(name, dateStr);
    }

    function saveItem() {
        if (isLoading) return;
        const id = document.getElementById('edit-id').value;
        const name = document.getElementById('edit-name').value.trim();
        const period = document.getElementById('edit-period').value;
        const color = document.getElementById('edit-color').value;
        const lastDate = document.getElementById('edit-last-date').value;

        if (!name || !period) { alert("åå‰ã¨æœŸé–“ã¯å¿…é ˆã§ã™"); return; }

        const newItemData = {
            id: id || Date.now().toString(),
            name: name,
            period: parseInt(period),
            color: color,
            lastDate: lastDate
        };

        setLoading(true);
        google.script.run
            .withSuccessHandler((serverData) => {
                items = serverData;
                clearEditForm();
                alert("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ");
                renderAll();
                setLoading(false);
            })
            .saveItemServer(newItemData);
    }

    function deleteItem(id) {
        if (isLoading) return;
        if (!confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        
        setLoading(true);
        google.script.run
            .withSuccessHandler((serverData) => {
                items = serverData;
                if (document.getElementById('edit-id').value === id) clearEditForm();
                renderAll();
                setLoading(false);
            })
            .deleteItemServer(id);
    }

    function editItem(id) {
        const item = items.find(i => i.id === id);
        if (!item) return;
        document.getElementById('edit-title').textContent = "é …ç›®ã‚’ç·¨é›†";
        document.getElementById('edit-id').value = item.id;
        document.getElementById('edit-name').value = item.name;
        document.getElementById('edit-period').value = item.period;
        document.getElementById('edit-color').value = item.color;
        document.getElementById('edit-last-date').value = item.lastDate;
        document.getElementById('settings-screen').scrollIntoView();
    }

    function clearEditForm() {
        document.getElementById('edit-title').textContent = "æ–°è¦é …ç›®ç™»éŒ²";
        document.getElementById('edit-id').value = "";
        document.getElementById('edit-name').value = "";
        document.getElementById('edit-period').value = "";
        document.getElementById('edit-color').value = "#3B82F6";
        document.getElementById('edit-last-date').value = "";
    }

    // --- ç”»é¢åˆ‡ã‚Šæ›¿ãˆ ---
    function toggleScreen(name) {
        const settings = document.getElementById('settings-screen');
        const home = document.getElementById('home-screen');
        if (name === 'settings') {
            if (!settings.classList.contains('hidden')) {
                settings.classList.add('hidden');
                home.classList.remove('hidden');
                document.body.classList.remove('modal-open');
                return;
            }
            settings.classList.remove('hidden');
            home.classList.add('hidden');
            document.body.classList.add('modal-open');
            window.scrollTo(0,0);
        } else {
            settings.classList.add('hidden');
            home.classList.remove('hidden');
            document.body.classList.remove('modal-open');
        }
    }
</script>
</body>
</html>